machine:
  node:
    version: 4.5.0

general:
  artifacts:
    - "app/.meteor/local/log"
    - "app/.coverage"
    - "log"

dependencies:
  cache_directories:
    - "~/.npm"
    - "~/.meteor"
    - "~/.yarn-cache"
    - "app/node_modules"
    - "app/.meteor/local/build"
    - "app/.meteor/local/bundler-cache"
    - "app/.meteor/local/isopacks"
    - "app/.meteor/local/plugin-cache"
    - "/opt/circleci/nodejs/v4.5.0/bin"
    - "/opt/circleci/nodejs/v4.5.0/lib/node_modules"

  override:
    - if [ ! -e ~/.yarn ]; then curl -o- -L https://yarnpkg.com/install.sh | bash; fi
    - (cd app; ./.testing/cache_meteor.sh)
    - (cd app; ./.testing/cache_npm_dependencies.sh)
    - (cd app; ./.testing/cache_build_and_dependencies.sh):
        timeout: 1200
    - (cd app; meteor npm install)

checkout:
  post:
    - git submodule update --init

test:
  override:
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
         
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
         
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
         
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
         
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
    
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
         
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
         
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
         
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
         
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
    - (cd app; meteor npm run coverage-app-full)
    
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-unit)
    - (cd app; meteor npm run coverage-app-unit)
         
deployment:
  production:
    branch: master
    commands:
      # Publish code coverage data (only works on master branch).
      - npm install -g codacy-coverage@2.0.0
      - cat app/.coverage/lcov.info | CODACY_PROJECT_TOKEN=$CODACY_PROJECT_TOKEN codacy-coverage --commit $CIRCLE_SHA1 --verbose --debug

      # Decrypt Meteor Up config
      - (cd .deploy/production; gpg --no-use-agent --quiet --passphrase $MUP_PASSPHRASE -o mup.js -d mup.js.gpg)

      # Deploy
      - npm install -g ssh2@0.4.15 # needed for meteor-up
      - npm install -g mup@1.0.1 # install meteor-up for deployment
      - (cd .deploy/production; mup deploy)

      # Notify Rollbar about deploy
      - curl https://api.rollbar.com/api/1/deploy/ -F access_token=$ROLLBAR_SERVER_ACCESS_TOKEN -F environment=production -F revision=$CIRCLE_SHA1 -F local_username=$CIRCLE_USERNAME
